<!DOCTYPE html>
<html lang="en">
    <head>
        <meta charset="UTF-8">
        <title>WebSocket Chat</title>
        <script src="https://cdn.jsdelivr.net/npm/p5@1.4.1/lib/p5.js"></script>
		<link href="public/style.css" rel="stylesheet" type="text/css" />
    </head>
    <body>
        <div class="message_div">
            <textarea id="player_input"></textarea>
            <p id="response_p"></p>
        </div>

        <script>
            const input = document.querySelector("#player_input");
            const response_p = document.querySelector("#response_p");
            const websocket = new WebSocket("ws://localhost:3000/ws");

            let background_sprite;
            let character_sprites = {};
            let current_emotion = "NEUTRAL";
            let current_message = "";
            let current_message_timer = 0; 

            websocket.onopen = function() {
                console.log("connection opened");
            }
            websocket.onclose = function() {
                console.log("connection closed");
            }
            websocket.onmessage = function(e) {
                console.log("received message: "+e.data);

                let res = JSON.parse(e.data);

                current_message = res.message;
                if ( character_sprites[res.emotion] ) {
                    current_emotion = res.emotion;
                }
                current_message_timer = Date.now();
            }
            input.onkeydown = function(e) {
                if (e.key == "Enter") {
                    websocket.send(input.value);
                    input.value = "";
                }
            }


            function preload() {
                background_sprite = loadImage('public/assets/backgrounds/default.png');

                let emotions = ["CONCERNED", "CRYING", "LAUGHING", "NEUTRAL", "SAD"];
                for (let emotion of emotions) {
                    character_sprites[emotion] = loadImage(`public/assets/character/${emotion}.png`);
                    character_sprites[emotion + "SPEAKING"] = loadImage(`public/assets/character/${emotion}SPEAKING.png`);
                }
            }
            function setup(){
                createCanvas( windowWidth, windowHeight );
            }
            function draw() {
                background( 255, 255, 255 );

                let background_scalar = windowHeight / background_sprite.height;
                
                push();
                translate( (windowWidth / 2) - ((1280 * background_scalar) / 2), 0);
                scale(background_scalar);
                
                tint(0,0,0,255/2);
                image(background_sprite, 0, 0, 1280, 800);

                let char_ind = floor((Date.now() - current_message_timer) / 20);

                if ( char_ind < current_message.length || current_message[char_ind] == '.' ) {
                    tint(0,0,0,255/2);
                    image(character_sprites[current_emotion + "SPEAKING"], (1280 - 960) / 2, 0, 960, 960);
                } else {
                    tint(0,0,0,255);
                    image(character_sprites[current_emotion], (1280 - 960) / 2, 0, 960, 960);
                }

                pop();

                response_p.innerHTML = current_message.substring(0, char_ind);
            }
        </script>
    </body>
</html>